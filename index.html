<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>إدارة المستخدمين</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.0.0-crypto-js.js"></script>
</head>
<body>
  <header>
    <h1>إدارة الموظفين</h1>
  </header>

  <main>
    <button id="viewRatingsBtn" style="display: none;" onclick="viewRatings()">عرض التقييمات 📊</button>
    <button id="excelBtn" style="display: none;" onclick="downloadExcel()">تنزيل Excel 📥</button>
    <button id="manageUsersBtn" style="display: none;" onclick="manageUsers()">إدارة المستخدمين 🛠️</button>

    <h2>قائمة الموظفين</h2>
    <ul id="employeeList"></ul>
    
    <footer>
      <p>&copy; <span id="year"></span> جميع الحقوق محفوظة</p>
    </footer>
  </main>

  <script>
    const SECRET_KEY = "smart_era_secret_@2024";
    const SESSION_KEY = "auth";
    let allEmployees = [];

    // دالة فك التشفير لجلسة المستخدم
    function decryptSession() {
      try {
        const encryptedSession = sessionStorage.getItem(SESSION_KEY);
        if (!encryptedSession) throw new Error('الجلسة منتهية أو غير موجودة');
        
        const bytes = CryptoJS.AES.decrypt(encryptedSession, SECRET_KEY);
        const sessionData = JSON.parse(bytes.toString(CryptoJS.enc.Utf8));
        
        if (!sessionData?.permissions?.includes('view')) {
          throw new Error('لا تملك صلاحية الوصول');
        }
        
        return sessionData;
      } catch (error) {
        logout();
        return null;
      }
    }

    // دالة للتحقق من الصلاحيات وعرض الأزرار بناءً عليها
    function verifyPermissions() {
      const session = decryptSession();
      if (!session) return;

      const isAdmin = session.user === 'hradmin';
      const canViewRatings = session.permissions.includes("📋 عرض التقييمات");

      // عرض الأزرار حسب الصلاحيات
      document.getElementById('excelBtn').style.display = isAdmin ? 'inline-block' : 'none';
      document.getElementById('manageUsersBtn').style.display = isAdmin ? 'inline-block' : 'none';
      document.getElementById('viewRatingsBtn').style.display = canViewRatings ? 'inline-block' : 'none';
    }

    // دالة لعرض التقييمات
    function viewRatings() {
      alert("عرض التقييمات");
      // هنا تضيف الكود الخاص بعرض التقييمات
    }

    // دالة لتنزيل ملف Excel
    function downloadExcel() {
      alert("تنزيل Excel");
      // هنا تضيف الكود الخاص بتنزيل ملف Excel
    }

    // دالة لإدارة المستخدمين
    function manageUsers() {
      alert("إدارة المستخدمين");
      // هنا تضيف الكود الخاص بإدارة المستخدمين
    }

    // دالة لجلب بيانات الموظفين
    function fetchEmployees() {
      fetch("https://example.com/employees")  // ضع هنا الرابط الصحيح لبيانات الموظفين
        .then(response => response.json())
        .then(data => {
          allEmployees = data;
          displayEmployees();
        })
        .catch(error => console.error("خطأ في جلب البيانات: ", error));
    }

    // دالة لعرض بيانات الموظفين
    function displayEmployees() {
      const employeeList = document.getElementById("employeeList");
      employeeList.innerHTML = "";

      allEmployees.forEach(employee => {
        const li = document.createElement("li");
        li.textContent = `${employee.name} - ${employee.position}`;
        employeeList.appendChild(li);
      });
    }

    // تابع تنفيذ التوابع عند تحميل الصفحة
    window.onload = () => {
      verifyPermissions();
      fetchEmployees();
      document.getElementById("year").textContent = new Date().getFullYear();
    };
  </script>
</body>
</html>
