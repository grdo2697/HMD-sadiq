<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <!-- باقي الهيد بدون تغيير -->
  <script>
    const SECRET_KEY = "smart_era_secret_@2024";
    const SESSION_KEY = "auth";

    function decryptSession() {
      try {
        const encrypted = sessionStorage.getItem(SESSION_KEY);
        if (!encrypted) {
          window.location.href = "login.html";
          return null;
        }
        
        const bytes = CryptoJS.AES.decrypt(encrypted, SECRET_KEY);
        const session = JSON.parse(bytes.toString(CryptoJS.enc.Utf8));
        
        // التحقق من صلاحية الجلسة (1 ساعة)
        if (Date.now() - session.timestamp > 3600000) {
          throw new Error("انتهت الجلسة");
        }
        
        return session;
      } catch (error) {
        console.error("خطأ في فك التشفير:", error);
        handleAuthError();
        return null;
      }
    }

    function verifyPermissions() {
      const session = decryptSession();
      if (!session) return;
      
      // إظهار الأزرار للمدير فقط
      if (session.user === "hr" && session.permissions.includes('admin')) {
        document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'inline-block');
      }
    }

    let allEmployees = [];

    async function fetchEmployees() {
      try {
        // إضافة مؤشر تحميل
        showLoader();
        
        // بيانات تجريبية للاختبار
        const testData = [
          { name: "محمد الجواد", id: "100", role: "مدير النظام", status: "نشط" },
          { name: "أحمد سعيد", id: "101", role: "مطور ويب", status: "مغلق" }
        ];
        
        // تعليق الاتصال الحالي للاختبار
        // const res = await fetch("رابط_API");
        // const data = await res.json();
        
        allEmployees = testData;
        updateFilters();
        displayEmployees(allEmployees);
        
      } catch (err) {
        showError("فشل في جلب البيانات: " + err.message);
      } finally {
        hideLoader();
      }
    }

    function displayEmployees(data) {
      const tbody = document.getElementById("employee-body");
      tbody.innerHTML = "";
      
      if (!data || data.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="4" class="no-data">
              <img src="empty-state.svg" alt="لا توجد بيانات">
              <p>لا توجد سجلات متاحة</p>
            </td>
          </tr>`;
        return;
      }

      data.forEach((emp, index) => {
        const row = `
          <tr>
            <td>${emp.name || 'بدون اسم'}</td>
            <td>${emp.id || 'N/A'}</td>
            <td>${emp.role || 'غير محدد'}</td>
            <td><span class="status-badge ${emp.status}">${emp.status || 'غير معروف'}</span></td>
          </tr>`;
        tbody.innerHTML += row;
      });
    }

    function showLoader() {
      const loader = document.createElement('div');
      loader.id = 'loading';
      loader.innerHTML = `
        <div class="loader"></div>
        <p>جاري تحميل البيانات...</p>
      `;
      document.body.appendChild(loader);
    }

    function hideLoader() {
      const loader = document.getElementById('loading');
      if (loader) loader.remove();
    }

    function showError(message) {
      const errorEl = document.createElement('div');
      errorEl.className = 'global-error';
      errorEl.innerHTML = `
        <span>⚠️</span>
        <p>${message}</p>
      `;
      document.body.appendChild(errorEl);
      setTimeout(() => errorEl.remove(), 5000);
    }

    // أنماط إضافية
    const style = document.createElement('style');
    style.innerHTML = `
      #loading {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255,255,255,0.9);
        display: grid;
        place-items: center;
        z-index: 9999;
      }
      
      .loader {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #0ea5e9;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
      }
      
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      
      .global-error {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: #fee2e2;
        color: #dc2626;
        padding: 1rem;
        border-radius: 8px;
        display: flex;
        align-items: center;
        gap: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      }
      
      .no-data {
        text-align: center;
        padding: 2rem;
      }
      
      .no-data img {
        width: 150px;
        opacity: 0.6;
        margin-bottom: 1rem;
      }
      
      .status-badge {
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.85em;
      }
      
      .status-badge.نشط { background: #dcfce7; color: #166534; }
      .status-badge.مغلق { background: #fee2e2; color: #991b1b; }
    `;
    document.head.appendChild(style);

    // التهيئة النهائية
    document.addEventListener('DOMContentLoaded', () => {
      verifyPermissions();
      fetchEmployees();
      document.getElementById("year").textContent = new Date().getFullYear();
    });
  </script>
</body>
</html>
