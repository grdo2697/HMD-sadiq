<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ø¹Ù‚ÙˆØ¨Ø§Øª Ù…ÙˆØ¸ÙÙŠ Ø§Ù„Ø¹ØµØ± Ø§Ù„Ø°ÙƒÙŠ</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600&display=swap" rel="stylesheet">
  <style>
    /* CSS Variables for theming */
    :root {
      --primary: #0ea5e9;
      --secondary: #38bdf8;
      --accent: #facc15;
      --background: #f9fafb;
      --text: #0f172a;
      --border: #cbd5e1;
      --hover: #e0f2fe;
    }
    /* Dark mode adjustments */
    .dark-mode {
      --background: #0f172a;
      --text: #f9fafb;
      --border: #334155;
      --hover: #1e293b;
    }
    /* Base styles */
    * {
      font-family: 'Cairo', sans-serif;
      box-sizing: border-box;
    }
    body {
      margin: 0;
      background: var(--background);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column; /* Added for footer pushing to bottom */
    }
    /* Header styles */
    header {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      padding: 2rem 1rem;
      text-align: center;
      color: #fff;
    }
    header h1 {
      margin: 0;
      font-size: 2.5rem;
    }
    /* Controls section */
    .controls {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 0.75rem; /* Slightly increased gap for better spacing */
      padding: 1rem;
      align-items: center;
    }
    .controls button,
    .controls input,
    .controls select {
      padding: 0.75rem; /* Slightly increased padding */
      border: 2px solid var(--border);
      border-radius: 8px;
      background: var(--background);
      cursor: pointer;
      font-size: 1rem;
      text-align: right;
      transition: all 0.2s ease-in-out; /* Added transition for hover effects */
    }
    .controls button.primary {
      background: var(--accent);
      color: #1e293b;
      border: none;
      font-weight: 600;
    }
    .controls button.primary:hover {
      background: #fde047;
      transform: translateY(-2px); /* Slight lift on hover */
    }
    .controls button:not(.primary):hover {
      border-color: var(--primary); /* Highlight border on hover for non-primary buttons */
    }
    /* Table styles */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
      box-shadow: 0 4px 6px rgba(0,0,0,0.05); /* Added subtle shadow */
    }
    th, td {
      padding: 1rem;
      border-bottom: 1px solid var(--border);
      text-align: right;
    }
    th {
      background: rgba(14, 165, 233, 0.1);
      color: var(--primary);
      font-weight: 600;
    }
    tr:hover {
      background: var(--hover);
    }
    /* Fixed position buttons (dark mode toggle, logout) */
    .toggle-dark, .logout-btn {
      position: fixed;
      top: 1rem;
      width: 40px;
      height: 40px;
      border: 2px solid var(--border);
      border-radius: 50%;
      display: grid;
      place-items: center;
      background: var(--background);
      cursor: pointer;
      font-size: 1.2rem; /* Larger icon */
      transition: all 0.2s ease-in-out;
      z-index: 100; /* Ensure buttons are on top */
    }
    .toggle-dark {
      left: 1rem;
    }
    .logout-btn {
      left: 4.5rem;
    }
    .toggle-dark:hover, .logout-btn:hover {
      background: var(--hover);
      border-color: var(--primary);
      transform: scale(1.05); /* Slight enlargement on hover */
    }
    /* Footer styles */
    footer {
      text-align: center;
      padding: 1rem;
      border-top: 1px solid var(--border);
      margin-top: auto; /* Pushes footer to the bottom */
      background: var(--background);
      color: var(--text);
      font-size: 0.9rem;
    }
  </style>
</head>
<body>
  <button class="toggle-dark" aria-label="Toggle dark mode" onclick="document.body.classList.toggle('dark-mode')">ğŸŒ™</button>
  <button class="logout-btn" aria-label="Logout" onclick="logout()">ğŸšª</button>

  <header>
    <h1>Ø¹Ù‚ÙˆØ¨Ø§Øª Ù…ÙˆØ¸ÙÙŠ Ø§Ù„Ø¹ØµØ± Ø§Ù„Ø°ÙƒÙŠ</h1>
  </header>

  <main class="container">
    <div class="controls">
      <button class="primary" onclick="fetchData()">ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
      <button class="primary" onclick="clearTable()">ğŸ—‘ï¸ Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„</button>
      <button class="primary" onclick="downloadExcel()">ğŸ“¥ ØªÙ†Ø²ÙŠÙ„ Excel</button>
      <button class="primary" onclick="window.location.href='index.html'">Ø±Ø¬ÙˆØ¹ Ù„Ù„Ù…ÙˆØ¸ÙÙŠÙ†</button>
      <select id="deptFilter" onchange="filterTable()">
        <option value="">ÙƒÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</option>
      </select>
      <input type="text" id="search" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù Ø£Ùˆ Ø³Ø¨Ø¨ Ø§Ù„Ø¹Ù‚ÙˆØ¨Ø©..." oninput="filterTable()" />
    </div>

    <table>
      <thead>
        <tr>
          <th>Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù</th>
          <th>Ø§Ù„Ù‚Ø³Ù…</th>
          <th>Ø§Ù„Ø¹Ù‚ÙˆØ¨Ø©/Ø§Ù„ØºØ±Ø§Ù…Ø©</th>
          <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
          <th>Ø³Ø¨Ø¨ Ø§Ù„Ø¹Ù‚ÙˆØ¨Ø©</th>
          <th>Ø§Ù„Ù…Ø¯ÙŠØ±</th>
          <th>Ù…Ù„Ø§Ø­Ø¸Ø© Ø§Ù„ØºØ±Ø§Ù…Ø©</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </main>

  <footer>
    Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø© Â© <span id="year"></span> | Ù„Ø¯Ù‰ - Ù…Ø­Ù…Ø¯ Ø§Ù„Ø¬ÙˆØ§Ø¯
  </footer>

  <script>
    // --- Security and Initialization ---

    // 1. Access Control: Only 'hr' user is allowed.
    // Redirects if not logged in or not 'hr'.
    const user = localStorage.getItem('username');
    if (!user) {
      // Not logged in â†’ redirect to login page
      window.location.href = 'login.html';
    } else if (user !== 'hr') {
      // Logged in but not 'hr' â†’ redirect to main employee page
      window.location.href = 'index.html';
    }

    // Set the current year in the footer
    document.getElementById('year').textContent = new Date().getFullYear();

    let penaltiesData = []; // Renamed 'data' to 'penaltiesData' for clarity

    // --- Data Handling ---

    /**
     * Fetches penalty data from the Google Apps Script endpoint.
     * Populates the department filter and renders the table upon successful fetch.
     */
    async function fetchData() {
      try {
        // Show a loading indicator if you have one (e.g., a spinner)
        // document.body.classList.add('loading');

        const response = await fetch(
          'https://script.google.com/macros/s/AKfycbz-Cx0mhpOeFz7X1concAY8SJhinisxHUfn40PF8BgJCr83DIwGvd0QGfKZa5K9uOuDDg/exec?sheet=Ø¹Ù‚ÙˆØ¨Ø§Øª'
        );

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        penaltiesData = await response.json();
        populateDeptFilter();
        renderTable(penaltiesData);
      } catch (error) {
        alert('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
        console.error('Error fetching data:', error);
      } finally {
        // Hide loading indicator
        // document.body.classList.remove('loading');
      }
    }

    /**
     * Populates the department filter dropdown with unique department names from the fetched data.
     */
    function populateDeptFilter() {
      const departments = [...new Set(penaltiesData.map(record => record.department))].sort();
      const departmentSelect = document.getElementById('deptFilter');
      departmentSelect.innerHTML = '<option value="">ÙƒÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</option>'; // Always include 'All Departments' option

      departments.forEach(dept => {
        // Ensure department is not empty or null before adding
        if (dept) {
          departmentSelect.innerHTML += `<option value="${dept}">${dept}</option>`;
        }
      });
    }

    /**
     * Renders the given array of penalty records into the table body.
     * @param {Array<Object>} records - An array of penalty objects to display.
     */
    function renderTable(records) {
      const tbody = document.getElementById('tbody');
      if (records.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§.</td></tr>';
        return;
      }
      tbody.innerHTML = records.map(record => `
        <tr>
          <td>${record.name || ''}</td>
          <td>${record.department || ''}</td>
          <td>${record.penalty || ''}</td>
          <td>${record.date || ''}</td>
          <td>${record.reason || ''}</td>
          <td>${record.manager || ''}</td>
          <td>${record.notes || ''}</td>
        </tr>
      `).join('');
    }

    /**
     * Clears all data from the table and the internal data array.
     */
    function clearTable() {
      penaltiesData = [];
      document.getElementById('tbody').innerHTML = '<tr><td colspan="7" style="text-align: center;">ØªÙ… Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.</td></tr>';
      document.getElementById('search').value = ''; // Clear search field
      document.getElementById('deptFilter').value = ''; // Reset department filter
    }

    /**
     * Filters the table based on search term and selected department.
     */
    function filterTable() {
      const searchTerm = document.getElementById('search').value.toLowerCase().trim();
      const departmentFilter = document.getElementById('deptFilter').value;

      const filteredData = penaltiesData.filter(record => {
        const matchesDepartment = departmentFilter === '' || record.department === departmentFilter;
        const matchesSearch =
          (record.name && record.name.toLowerCase().includes(searchTerm)) ||
          (record.reason && record.reason.toLowerCase().includes(searchTerm));
        return matchesDepartment && matchesSearch;
      });
      renderTable(filteredData);
    }

    /**
     * Downloads the current table data as an Excel (.xlsx) file.
     * Uses CSV format for simplicity, but named as .xlsx for common compatibility.
     */
    function downloadExcel() {
      const header = ['Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù','Ø§Ù„Ù‚Ø³Ù…','Ø§Ù„Ø¹Ù‚ÙˆØ¨Ø©/Ø§Ù„ØºØ±Ø§Ù…Ø©','Ø§Ù„ØªØ§Ø±ÙŠØ®','Ø³Ø¨Ø¨ Ø§Ù„Ø¹Ù‚ÙˆØ¨Ø©','Ø§Ù„Ù…Ø¯ÙŠØ±','Ù…Ù„Ø§Ø­Ø¸Ø© Ø§Ù„ØºØ±Ø§Ù…Ø©'];
      // Map data to match header order and ensure all fields are strings for CSV
      const rows = [header, ...penaltiesData.map(record => [
        record.name,
        record.department,
        record.penalty,
        record.date,
        record.reason,
        record.manager,
        record.notes
      ].map(item => `"${(item || '').toString().replace(/"/g, '""')}"`))]; // Handle commas/quotes in data

      const csvContent = rows.map(row => row.join(',')).join('\n');
      const blob = new Blob(['\uFEFE' + csvContent], { // '\uFEFF' is BOM for UTF-8 compatibility in Excel
        type: 'text/csv;charset=utf-8;'
      });

      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'Ø¹Ù‚ÙˆØ¨Ø§Øª_Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†.csv'; // Changed to .csv, as it's a CSV file
      document.body.appendChild(a); // Append to body to make it clickable
      a.click();
      document.body.removeChild(a); // Clean up
      URL.revokeObjectURL(url); // Release the object URL
    }

    /**
     * Logs out the user by clearing local storage and redirecting to the login page.
     */
    function logout() {
      localStorage.clear();
      window.location.href = 'login.html';
    }

    // --- Initial Data Load on Page Load ---
    fetchData();
  </script>
</body>
</html>
