<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>نظام عقوبات الموظفين - العصر الذكي</title>

    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <style>
        /* ------------------------------------------------ */
        /* 1. المتغيرات والألوان الأساسية (Theming System) */
        /* ------------------------------------------------ */
        /* تعريف الألوان للوضع الفاتح (Light Mode) */
        :root {
            --primary-color: #3B82F6;    /* أزرق جذاب - للخطوط الرئيسية والخلفيات المميزة */
            --secondary-color: #60A5FA; /* أزرق فاتح - كلون مكمل */
            --accent-color: #FACC15;     /* أصفر ذهبي - للأزرار الرئيسية والعمليات الهامة */
            --background-light: #F8FAFC; /* خلفية فاتحة جداً - لجسم الصفحة */
            --background-card: #FFFFFF; /* خلفية البطاقات/العناصر البيضاء - للصناديق والجدول */
            --text-dark: #1F2937;        /* نص غامق جداً - للنصوص الأساسية */
            --text-medium: #4B5563;      /* نص متوسط - للنصوص الثانوية والفوتر */
            --border-color: #E5E7EB;     /* حدود فاتحة - للخطوط الفاصلة والعناصر */
            --shadow-light: rgba(0, 0, 0, 0.05); /* ظل خفيف جداً - للعناصر المرتفعة */
            --hover-light: #EFF6FF;      /* لون تحويم فاتح جداً - لتأثيرات التحويم على الصفوف والعناصر */
        }

        /* تعريف الألوان للوضع الداكن (Dark Mode) - تتجاوز قيم الوضع الفاتح */
        .dark-mode {
            --primary-color: #60A5FA;    /* أزرق فاتح في الوضع الداكن */
            --secondary-color: #3B82F6; /* أزرق غامق في الوضع الداكن */
            --accent-color: #FDE047;     /* أصفر أكثر إشراقاً في الوضع الداكن */
            --background-light: #1F2937; /* خلفية داكنة جداً */
            --background-card: #374151; /* خلفية البطاقات/العناصر في الوضع الداكن */
            --text-dark: #F9FAFB;        /* نص فاتح جداً */
            --text-medium: #D1D5DB;      /* نص متوسط فاتح */
            --border-color: #4B5563;     /* حدود داكنة */
            --shadow-light: rgba(0, 0, 0, 0.2); /* ظل أغمق قليلاً في الوضع الداكن */
            --hover-light: #4B5563;      /* لون تحويم أغمق في الوضع الداكن */
        }

        /* ------------------------------------- */
        /* 2. الأنماط الأساسية (Base Styles)      */
        /* ------------------------------------- */
        /* إعادة تعيين الأنماط الافتراضية للمتصفح وتطبيق الخط */
        * {
            font-family: 'Cairo', sans-serif;
            box-sizing: border-box; /* يجعل ال padding وال border ضمن عرض العنصر */
            margin: 0;
            padding: 0;
        }

        /* أنماط جسم الصفحة (body) */
        body {
            background: var(--background-light); /* خلفية من المتغيرات */
            color: var(--text-dark); /* لون النص من المتغيرات */
            min-height: 100vh; /* ارتفاع الصفحة كاملة */
            display: flex;
            flex-direction: column; /* لترتيب المحتوى عمودياً والدفع بالفوتر للأسفل */
            transition: background 0.4s ease, color 0.4s ease; /* انتقال سلس عند تبديل الوضع الداكن */
        }

        /* ------------------------------------- */
        /* 3. الهيكل العام (Layout)              */
        /* ------------------------------------- */
        /* أنماط رأس الصفحة (Header) */
        header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); /* تدرج لوني للخلفية */
            padding: 2.5rem 1.5rem; /* مسافة داخلية */
            text-align: center; /* توسيط النص */
            color: #fff; /* لون النص أبيض */
            box-shadow: 0 4px 10px var(--shadow-light); /* ظل خفيف */
        }
        header h1 {
            margin: 0;
            font-size: 2.8rem; /* حجم الخط كبير */
            font-weight: 700; /* خط سميك */
            letter-spacing: 1px; /* تباعد بين الحروف */
        }

        /* أنماط الحاوية الرئيسية للمحتوى */
        .container {
            max-width: 1300px; /* أقصى عرض للحاوية */
            margin: 1.5rem auto; /* توسيط الحاوية مع مسافة علوية وسفلية */
            padding: 0 1.5rem; /* مسافة داخلية أفقية */
            flex-grow: 1; /* للسماح للحاوية بالنمو ودفع الفوتر للأسفل */
        }

        /* ------------------------------------- */
        /* 4. عناصر التحكم (Controls)            */
        /* ------------------------------------- */
        .controls {
            display: grid; /* استخدام Grid لترتيب العناصر */
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); /* أعمدة تتكيف مع الحجم */
            gap: 1rem; /* المسافة بين العناصر */
            padding: 1.5rem;
            background: var(--background-card); /* خلفية كخلفية البطاقات */
            border-radius: 12px; /* زوايا دائرية */
            box-shadow: 0 4px 10px var(--shadow-light); /* ظل */
            margin-bottom: 1.5rem; /* مسافة سفلية */
        }

        .controls button,
        .controls input,
        .controls select {
            padding: 0.85rem 1.2rem; /* مسافة داخلية */
            border: 1px solid var(--border-color); /* حدود رقيقة */
            border-radius: 8px; /* زوايا دائرية */
            background: var(--background-light); /* خلفية فاتحة */
            color: var(--text-dark); /* لون النص */
            font-size: 1rem;
            text-align: right; /* محاذاة النص لليمين */
            cursor: pointer; /* مؤشر اليد */
            transition: all 0.3s ease; /* انتقال سلس عند التفاعل */
            -webkit-appearance: none; /* إزالة أنماط المتصفح الافتراضية للـ select */
            -moz-appearance: none;
            appearance: none;
        }

        /* أنماط التركيز (عند النقر أو التبويب) */
        .controls input:focus,
        .controls select:focus {
            outline: none; /* إزالة الخط الأزرق الافتراضي */
            border-color: var(--primary-color); /* تغيير لون الحدود */
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2); /* ظل أزرق خفيف */
        }

        /* أنماط الأزرار بشكل عام */
        .controls button {
            display: flex; /* لترتيب الأيقونة والنص جنباً إلى جنب */
            align-items: center; /* محاذاة رأسية */
            justify-content: center; /* توسيط أفقي */
            gap: 0.75rem; /* مسافة بين الأيقونة والنص */
            font-weight: 600;
            text-decoration: none;
        }

        /* حجم أيقونات الأزرار */
        .controls button i {
            font-size: 1.1rem;
        }

        /* أنماط الأزرار الرئيسية (Primary) */
        .controls button.primary {
            background: var(--accent-color); /* خلفية باللون المميز */
            color: var(--text-dark); /* نص غامق على اللون المميز */
            border: none; /* بلا حدود */
            font-weight: 700;
        }
        /* تأثير التحويم على الأزرار الرئيسية */
        .controls button.primary:hover {
            background: #FACC15; /* لون أصفر أغمق قليلاً */
            transform: translateY(-3px); /* رفع العنصر للأعلى */
            box-shadow: 0 6px 12px rgba(250, 204, 21, 0.2); /* ظل أكبر وأوضح */
        }

        /* تأثير التحويم على الأزرار الأخرى */
        .controls button:not(.primary):hover {
            background: var(--hover-light); /* خلفية فاتحة عند التحويم */
            border-color: var(--primary-color); /* تغيير لون الحدود */
        }

        /* ------------------------------------- */
        /* 5. الجدول (Table)                    */
        /* ------------------------------------- */
        /* لجعل الجدول قابل للتمرير أفقيا على الشاشات الصغيرة */
        .table-responsive {
            overflow-x: auto;
            border-radius: 12px;
            box-shadow: 0 4px 10px var(--shadow-light);
            background: var(--background-card);
        }

        table {
            width: 100%;
            border-collapse: separate; /* مهم لتطبيق border-radius على خلايا الرأس */
            border-spacing: 0; /* إزالة المسافات بين الخلايا */
            min-width: 900px; /* عرض أدنى للجدول لضمان عدم تداخل الأعمدة */
        }

        /* أنماط خلايا الرأس والبيانات */
        th, td {
            padding: 1rem 1.2rem;
            text-align: right;
            border-bottom: 1px solid var(--border-color); /* حدود سفلية */
        }

        /* أنماط رؤوس الأعمدة */
        th {
            background: var(--primary-color); /* خلفية باللون الأساسي */
            color: #fff; /* نص أبيض */
            font-weight: 700;
            position: sticky; /* لتثبيت رؤوس الأعمدة عند التمرير */
            top: 0;
            z-index: 10; /* لضمان ظهورها فوق محتوى الجدول */
        }

        /* إزالة الحدود السفلية لآخر صف في الجدول (لكل من tbody و tfoot) */
        tbody tr:last-child td, tfoot tr:last-child td {
            border-bottom: none;
        }

        /* تأثير التحويم على صفوف الجدول */
        tbody tr:hover {
            background: var(--hover-light);
            cursor: pointer;
        }

        /* أنماط صف المجموع في tfoot */
        tfoot tr {
            background-color: var(--secondary-color); /* خلفية مميزة لصف المجموع */
            color: #fff; /* نص أبيض */
            font-weight: 700;
            font-size: 1.1rem;
        }
        tfoot td {
            border-top: 2px solid var(--primary-color); /* حد علوي سميك */
            padding: 1.2rem;
            text-align: center !important; /* توسيط النص */
        }
        tfoot td:first-child {
            text-align: right !important; /* محاذاة النص لليمين لأول خلية في الفوتر */
        }


        /* ------------------------------------- */
        /* 6. الأزرار العائمة (Fixed Buttons)   */
        /* ------------------------------------- */
        .fixed-buttons {
            position: fixed; /* تثبيت الأزرار في مكانها */
            top: 1.5rem; /* مسافة من الأعلى */
            left: 1.5rem; /* مسافة من اليسار */
            display: flex; /* لترتيب الأزرار جنباً إلى جنب */
            gap: 0.75rem; /* مسافة بين الأزرار */
            z-index: 200; /* لضمان ظهورها فوق كل العناصر الأخرى */
        }

        .fixed-buttons button {
            width: 50px;
            height: 50px;
            border-radius: 50%; /* لجعلها دائرية */
            background: var(--background-card);
            border: 1px solid var(--border-color);
            display: grid; /* لتوسيط الأيقونة */
            place-items: center;
            font-size: 1.4rem; /* حجم الأيقونة */
            cursor: pointer;
            box-shadow: 0 2px 5px var(--shadow-light); /* ظل خفيف */
            transition: all 0.3s ease; /* انتقال سلس */
            color: var(--text-medium); /* لون الأيقونة */
        }
        /* تأثير التحويم على الأزرار العائمة */
        .fixed-buttons button:hover {
            background: var(--hover-light);
            border-color: var(--primary-color);
            transform: scale(1.1) rotate(5deg); /* تكبير ودوران خفيف */
            color: var(--primary-color); /* تغيير لون الأيقونة */
        }

        /* ------------------------------------- */
        /* 7. الفوتر (Footer)                   */
        /* ------------------------------------- */
        footer {
            text-align: center;
            padding: 1.5rem;
            border-top: 1px solid var(--border-color); /* حدود علوية */
            margin-top: 2rem; /* مسافة من الجدول */
            background: var(--background-light);
            color: var(--text-medium);
            font-size: 0.9rem;
        }

        /* ------------------------------------- */
        /* 8. مؤشر التحميل (Loading Spinner)     */
        /* ------------------------------------- */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.3); /* خلفية شبه شفافة */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 999; /* لضمان ظهورها فوق كل شيء */
            visibility: hidden; /* مخفية في البداية */
            opacity: 0; /* شفافة في البداية */
            transition: opacity 0.3s ease, visibility 0.3s ease; /* انتقال سلس للظهور والاختفاء */
        }
        .loading-overlay.visible {
            visibility: visible; /* مرئية عند إضافة الكلاس */
            opacity: 1; /* غير شفافة */
        }
        .spinner {
            border: 8px solid var(--border-color); /* حدود الحلقة الخارجية */
            border-top: 8px solid var(--primary-color); /* جزء ملون للحركة */
            border-radius: 50%; /* لجعلها دائرية */
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite; /* تطبيق حركة الدوران */
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div id="loadingOverlay" class="loading-overlay">
        <div class="spinner"></div>
    </div>

    <div class="fixed-buttons">
        <button aria-label="تبديل الوضع الليلي/النهاري" onclick="document.body.classList.toggle('dark-mode')">
            <i class="fas fa-moon"></i>
        </button>
        <button aria-label="تسجيل الخروج" onclick="logout()">
            <i class="fas fa-sign-out-alt"></i>
        </button>
    </div>

    <header>
        <h1>نظام عقوبات الموظفين</h1>
    </header>

    <main class="container">
        <div class="controls">
            <button class="primary" onclick="fetchData()">
                <i class="fas fa-sync-alt"></i> تحديث البيانات
            </button>
            <button class="primary" onclick="clearTable()">
                <i class="fas fa-trash-alt"></i> مسح الكل
            </button>
            <button class="primary" onclick="downloadExcel()">
                <i class="fas fa-download"></i> تنزيل Excel
            </button>
            <button class="primary" onclick="window.location.href='index.html'">
                <i class="fas fa-users"></i> رجوع للموظفين
            </button>
            <select id="deptFilter" onchange="filterTable()">
                <option value="">كل الأقسام</option>
            </select>
            <input type="text" id="search" placeholder="بحث باسم الموظف أو سبب العقوبة..." oninput="filterTable()" />
        </div>

        <div class="table-responsive">
            <table>
                <thead>
                    <tr>
                        <th>اسم الموظف</th>
                        <th>القسم</th>
                        <th>نوع العقوبة</th>
                        <th>التاريخ</th>
                        <th>سبب العقوبة</th>
                        <th>المدير</th>
                        <th>ملاحظة الغرامة</th>
                        <th>قيمة الغرامة</th>
                    </tr>
                </thead>
                <tbody id="tbody">
                    </tbody>
                <tfoot id="tfoot">
                    </tfoot>
            </table>
        </div>
    </main>

    <footer>
        جميع الحقوق محفوظة © <span id="year"></span> | لدى - محمد الجواد
    </footer>

    <script>
        // --- التحكم بالوصول والتهيئة الأولية ---

        const user = localStorage.getItem('username');
        if (!user) {
            window.location.href = 'login.html';
        } else if (user !== 'hr') {
            window.location.href = 'index.html';
        }

        document.getElementById('year').textContent = new Date().getFullYear();

        let penaltiesData = [];
        const loadingOverlay = document.getElementById('loadingOverlay');

        function showLoading() {
            loadingOverlay.classList.add('visible');
        }

        function hideLoading() {
            loadingOverlay.classList.remove('visible');
        }

        // --- جلب البيانات من Google Apps Script ---

        async function fetchData() {
            showLoading();
            try {
                // *** تم تحديث هذا الرابط بالرابط الجديد الذي أرسلته لي ***
                const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyESkGrUrI-Kume1NwgjhEuGdJOIdMR4hfKf8E1Kj9DxvFQPUAwWAI1Qpqw8RWfarKVCA/exec?sheet=عقوبات';
                const response = await fetch(SCRIPT_URL);

                if (!response.ok) {
                    throw new Error(`خطأ في الشبكة أو الخادم: ${response.status}`);
                }

                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.error || 'خطأ غير معروف من السيرفر.');
                }

                penaltiesData = result.data;
                populateDeptFilter();
                renderTable(penaltiesData); // استدعاء لعرض الجدول والمجموع
            } catch (error) {
                alert(`فشل تحميل البيانات: ${error.message}. يرجى التأكد من اتصالك بالإنترنت أو المحاولة مرة أخرى لاحقًا.`);
                console.error('خطأ في جلب البيانات:', error);
                renderTable([]); // عرض جدول فارغ مع رسالة الخطأ
            } finally {
                hideLoading();
            }
        }

        // --- معالجة البيانات وعرضها ---

        function populateDeptFilter() {
            const departments = [...new Set(penaltiesData.map(record => record.القسم))].sort();
            const departmentSelect = document.getElementById('deptFilter');
            
            departmentSelect.innerHTML = '<option value="">كل الأقسام</option>';

            departments.forEach(dept => {
                if (dept && dept !== '—') {
                    departmentSelect.innerHTML += `<option value="${dept}">${dept}</option>`;
                }
            });
        }

        /**
         * وظيفة لعرض مصفوفة من سجلات العقوبات في جسم الجدول (tbody)
         * وحساب وعرض مجموع الغرامات في tfoot.
         * @param {Array<Object>} records - مصفوفة كائنات العقوبات لعرضها.
         */
        function renderTable(records) {
            const tbody = document.getElementById('tbody');
            const tfoot = document.getElementById('tfoot'); // الحصول على عنصر tfoot
            
            if (records.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 20px; color: var(--text-medium);">لا توجد بيانات لعرضها حالياً.</td></tr>';
                tfoot.innerHTML = ''; // إزالة أي محتوى سابق من tfoot
                return;
            }

            tbody.innerHTML = records.map(record => `
                <tr>
                    <td>${record.الاسم || '—'}</td>
                    <td>${record.القسم || '—'}</td>
                    <td>${record.نوع_العقوبة || '—'}</td>
                    <td>${record.التاريخ || '—'}</td>
                    <td>${record.سبب_العقوبة || '—'}</td>
                    <td>${record.المدير || '—'}</td>
                    <td>${record.ملاحظة_الغرامة || '—'}</td>
                    <td>${(parseFloat(record.قيمة_الغرامة) || 0).toLocaleString('ar-IQ', { style: 'currency', currency: 'IQD' })}</td>
                </tr>
            `).join('');

            // حساب وعرض المجموع
            calculateAndDisplayTotal(records);
        }

        /**
         * وظيفة لحساب المجموع الكلي لعمود "قيمة الغرامة" وعرضه في tfoot.
         * @param {Array<Object>} records - مصفوفة كائنات العقوبات لحساب المجموع منها.
         */
        function calculateAndDisplayTotal(records) {
            const tfoot = document.getElementById('tfoot');
            let totalFine = 0;

            records.forEach(record => {
                // التأكد من أن قيمة الغرامة رقم صالح قبل إضافتها للمجموع
                // ونقوم بإزالة أي رموز عملة أو فواصل آلاف قبل التحويل لضمان صحة الرقم
                // نحول القيمة إلى String أولاً للتأكد من استخدام .replace بشكل صحيح
                const rawFineValue = record.قيمة_الغرامة ? String(record.قيمة_الغرامة).replace(/[^\d.]/g, '') : '';
                const fineValue = parseFloat(rawFineValue);
                if (!isNaN(fineValue)) {
                    totalFine += fineValue;
                }
            });

            // إنشاء صف المجموع
            // colspan = 7 لأننا نريد أن يمتد النص على 7 أعمدة، ويبقى عمود واحد للمجموع الفعلي
            tfoot.innerHTML = `
                <tr>
                    <td colspan="7" style="text-align: right; padding-right: 20px;">المجموع الكلي للغرامات:</td>
                    <td>${totalFine.toLocaleString('ar-IQ', { style: 'currency', currency: 'IQD' })}</td> </tr>
            `;
        }

        function clearTable() {
            penaltiesData = [];
            // colspan = 8 لرؤوس الأعمدة، و <tfoot> سيكون فارغًا
            document.getElementById('tbody').innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 20px; color: var(--text-medium);">تم مسح جميع البيانات بنجاح.</td></tr>';
            document.getElementById('tfoot').innerHTML = ''; // مسح صف المجموع عند مسح الجدول
            document.getElementById('search').value = '';
            document.getElementById('deptFilter').value = '';
        }

        function filterTable() {
            const searchTerm = document.getElementById('search').value.toLowerCase().trim();
            const departmentFilter = document.getElementById('deptFilter').value;

            const filteredData = penaltiesData.filter(record => {
                const matchesDepartment = departmentFilter === '' || record.القسم === departmentFilter;
                const matchesSearch =
                    (record.الاسم && record.الاسم.toLowerCase().includes(searchTerm)) ||
                    (record.سبب_العقوبة && record.سبب_العقوبة.toLowerCase().includes(searchTerm));
                
                return matchesDepartment && matchesSearch;
            });
            renderTable(filteredData); // ستقوم renderTable بتحديث المجموع تلقائياً
        }

        function downloadExcel() {
            if (penaltiesData.length === 0) {
                alert('لا توجد بيانات لتنزيلها.');
                return;
            }

            const header = ['اسم الموظف', 'القسم', 'نوع العقوبة', 'التاريخ', 'سبب العقوبة', 'المدير', 'ملاحظة الغرامة', 'قيمة الغرامة'];
            
            // للحفاظ على تنسيق العملة في ملف Excel (CSV)، قد تحتاج لتركه كرقم وتنسيقه في Excel نفسه،
            // أو إضافته كنص مع "د.ع" إذا كان هذا مقبولاً لملف CSV.
            // هنا سنعيد استخدام التنسيق لضمان أن ما يظهر في CSV هو نفسه في الجدول
            const rows = [header, ...penaltiesData.map(record => [
                record.الاسم,
                record.القسم,
                record.نوع_العقوبة,
                record.التاريخ,
                record.سبب_العقوبة,
                record.المدير,
                record.ملاحظة_الغرامة,
                // تنسيق القيمة لملف CSV أيضاً
                (parseFloat(record.قيمة_الغرامة) || 0).toLocaleString('ar-IQ', { style: 'currency', currency: 'IQD' })
            ].map(item => `"${(item || '').toString().replace(/"/g, '""')}"`))];

            const csvContent = rows.map(row => row.join(',')).join('\n');
            
            const blob = new Blob(['\uFEFF' + csvContent], {
                type: 'text/csv;charset=utf-8;'
            });

            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'عقوبات_الموظفين.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function logout() {
            localStorage.clear();
            window.location.href = 'login.html';
        }

        fetchData();
    </script>
</body>
</html>
