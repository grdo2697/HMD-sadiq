<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <!-- ... (Ø¨Ù‚ÙŠØ© Ø§Ù„Ù‡ÙŠØ¯ Ø¨Ø¯ÙˆÙ† ØªØºÙŠÙŠØ±) ... -->
  
  <style>
    /* Ø¥Ø¶Ø§ÙØ© Ø£Ù†Ù…Ø§Ø· Ø¬Ø¯ÙŠØ¯Ø© */
    .password-field {
      position: relative;
    }
    
    .toggle-password {
      position: absolute;
      left: 10px;
      top: 50%;
      transform: translateY(-50%);
      cursor: pointer;
    }
    
    .status-message {
      padding: 0.5rem;
      border-radius: 6px;
      margin-top: 1rem;
      display: none;
    }
    
    .success { background: #dcfce7; color: #166534; }
    .error { background: #fee2e2; color: #dc2626; }
  </style>
</head>
<body>
  <!-- ... (Ø¨Ù‚ÙŠØ© Ø§Ù„Ù‡ÙŠÙƒÙ„ ÙƒÙ…Ø§ Ù‡Ùˆ) ... -->

  <script>
    // Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø¹Ù„Ù‰ Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø¨Ø±Ù…Ø¬ÙŠ

    const SECRET_KEY = "smart_era_secret_@2024";
    const USERS_KEY = "smart_era_users";
    const SESSION_KEY = "auth";

    let isEditMode = false;
    let currentEditIndex = null;

    // ØªØ­Ø³ÙŠÙ† Ø¯Ø§Ù„Ø© ÙÙƒ Ø§Ù„ØªØ´ÙÙŠØ±
    function decryptSession() {
      try {
        const encrypted = sessionStorage.getItem(SESSION_KEY);
        if (!encrypted) throw new Error('No session found');
        
        const bytes = CryptoJS.AES.decrypt(encrypted, SECRET_KEY);
        const session = JSON.parse(bytes.toString(CryptoJS.enc.Utf8));
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ø¬Ù„Ø³Ø© (1 Ø³Ø§Ø¹Ø©)
        const sessionAge = Date.now() - session.timestamp;
        if (sessionAge > 3600000) throw new Error('Ø§Ù†ØªÙ‡Øª ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ø¬Ù„Ø³Ø©');
        
        return session;
      } catch (error) {
        console.error('ÙÙƒ Ø§Ù„ØªØ´ÙÙŠØ± ÙØ´Ù„:', error);
        handleAuthError();
        return null;
      }
    }

    // ØªØ­Ø³ÙŠÙ† Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª
    function verifyAdminPermissions() {
      const session = decryptSession();
      const isHrAdmin = session?.user === 'hr' && session?.permissions?.includes('admin');
      
      if (!isHrAdmin) {
        alert('âš ï¸ ÙŠÙ„Ø²Ù… ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø¯ÙŠØ± Ù„Ù„ÙˆØµÙˆÙ„ Ù„Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø©');
        window.location.href = 'index.html';
      }
    }

    // ØªØ­Ø³ÙŠÙ† Ø¯Ø§Ù„Ø© Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
    function saveUsers(users) {
      try {
        const encrypted = CryptoJS.AES.encrypt(
          JSON.stringify(users), 
          SECRET_KEY
        ).toString();
        localStorage.setItem(USERS_KEY, encrypted);
        showStatus('ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­', 'success');
      } catch (error) {
        showStatus('ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø­ÙØ¸: ' + error.message, 'error');
      }
    }

    // Ø¥Ø¶Ø§ÙØ© Ø¯Ø§Ù„Ø© Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø­Ø§Ù„Ø©
    function showStatus(message, type) {
      const statusEl = document.createElement('div');
      statusEl.className = `status-message ${type}`;
      statusEl.textContent = message;
      
      const form = document.getElementById('userForm');
      form.appendChild(statusEl);
      
      setTimeout(() => statusEl.remove(), 3000);
    }

    // ØªØ­Ø³ÙŠÙ† Ø¯Ø§Ù„Ø© Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù…
    function addUser() {
      try {
        const newUser = getFormData();
        
        // ØªØ­Ø³ÙŠÙ† Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        const validationErrors = validateUser(newUser);
        if (validationErrors.length > 0) {
          throw new Error(validationErrors.join('\n'));
        }

        const users = getUsers();
        
        // Ù…Ù†Ø¹ ØªÙƒØ±Ø§Ø± Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
        if (users.some(u => u.username.toLowerCase() === newUser.username.toLowerCase())) {
          throw new Error('Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹');
        }

        users.push(newUser);
        saveUsers(users);
        renderUsers();
        resetForm();
      } catch (error) {
        showStatus(error.message, 'error');
      }
    }

    // ØªØ­Ø³ÙŠÙ† Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    function validateUser({ username, password }) {
      const errors = [];
      const usernameRegex = /^[a-zA-Z0-9_]{3,20}$/;
      const passwordRegex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d).{8,}$/;

      if (!usernameRegex.test(username)) {
        errors.push('Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ­ØªÙˆÙŠ 3-20 Ø­Ø±ÙØ§Ù‹ (Ø£Ø±Ù‚Ø§Ù…/Ø­Ø±ÙˆÙ/_)');
      }
      
      if (!passwordRegex.test(password)) {
        errors.push('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙŠØ¬Ø¨ Ø£Ù† ØªØ­ØªÙˆÙŠ 8 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ØŒ Ø­Ø±Ù ÙƒØ¨ÙŠØ± ÙˆØµØºÙŠØ± ÙˆØ±Ù‚Ù…');
      }

      return errors;
    }

    // ØªØ­Ø³ÙŠÙ† Ø¯Ø§Ù„Ø© Ø§Ù„Ø¹Ø±Ø¶
    function renderUsers() {
      const tbody = document.getElementById('usersList');
      const users = getUsers();
      
      tbody.innerHTML = users.map((user, index) => {
        const isCurrentUser = user.username === decryptSession()?.user;
        
        return `
          <tr>
            <td>${user.username}</td>
            <td>
              ${user.permissions.includes('admin') 
                ? '<span class="badge admin">Ù…Ø¯ÙŠØ± ÙƒØ§Ù…Ù„</span>' 
                : user.permissions.join('ØŒ ') || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}
            </td>
            <td>
              ${user.username === 'hr' 
                ? '<span class="text-muted">ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­</span>'
                : `
                  <button class="btn btn-edit" 
                    onclick="editUser(${index})"
                    ${isCurrentUser ? 'disabled' : ''}>
                    âœï¸ ØªØ¹Ø¯ÙŠÙ„
                  </button>
                  <button class="btn btn-danger" 
                    onclick="deleteUser(${index})"
                    ${isCurrentUser ? 'disabled' : ''}>
                    ğŸ—‘ï¸ Ø­Ø°Ù
                  </button>
                `}
            </td>
          </tr>
        `;
      }).join('');
    }

    // Ø§Ù„Ø¨Ø§Ù‚ÙŠ Ø¨Ø¯ÙˆÙ† ØªØºÙŠÙŠØ±
    // ...
    
  </script>
</body>
</html>
