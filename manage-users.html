<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† - Ø´Ø±ÙƒØ© Ø§Ù„Ø¹ØµØ± Ø§Ù„Ø°ÙƒÙŠ</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
  <style>
    body { font-family: 'Cairo', sans-serif; background: #f9fafb; color: #0f172a; margin: 0; padding: 2rem; }
    header { text-align: center; margin-bottom: 2rem; }
    h1 { font-size: 2rem; }
    form { max-width: 600px; margin: auto 0 2rem; background: #fff; padding: 1.5rem; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .form-group { margin-bottom: 1rem; position: relative; }
    .form-group label { display: block; margin-bottom: 0.5rem; }
    .form-group input[type="text"], .form-group input[type="password"] { width: 100%; padding: 0.75rem; border: 1px solid #cbd5e1; border-radius: 6px; }
    .toggle-password { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); cursor: pointer; }
    .btn { display: inline-block; padding: 0.75rem 1.5rem; border: none; background: #0ea5e9; color: #fff; border-radius: 6px; cursor: pointer; margin-right: 0.5rem; }
    .btn-danger { background: #ef4444; }
    table { width: 100%; border-collapse: collapse; background: #fff; border-radius: 6px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    th, td { padding: 1rem; border-bottom: 1px solid #cbd5e1; text-align: center; }
    .badge { padding: 0.25rem 0.75rem; border-radius: 4px; font-size: 0.9rem; }
    .badge.admin { background: #fde047; color: #1e293b; }
    .text-muted { color: #94a3b8; }
    .status-message { padding: 0.5rem; border-radius: 6px; margin-top: 1rem; display: none; }
    .success { background: #dcfce7; color: #166534; }
    .error { background: #fee2e2; color: #dc2626; }
  </style>
</head>
<body>
  <header>
    <h1>ØµÙØ­Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h1>
  </header>

  <form id="userForm" onsubmit="event.preventDefault(); isEditMode ? updateUser() : addUser();">
    <div class="form-group password-field">
      <label for="username">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
      <input type="text" id="username" required placeholder="Ù…Ø«Ø§Ù„: johndoe" />
    </div>
    <div class="form-group password-field">
      <label for="password">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
      <input type="password" id="password" required placeholder="********" />
      <span class="toggle-password" onclick="togglePassword()">ğŸ‘ï¸</span>
    </div>
    <div class="form-group">
      <label>Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª</label><br>
      <label><input type="checkbox" id="perm-admin" value="admin" /> Ù…Ø¯ÙŠØ± ÙƒØ§Ù…Ù„</label><br>
      <label><input type="checkbox" id="perm-view" value="view" /> Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª</label><br>
      <label><input type="checkbox" id="perm-download" value="download" /> ØªÙ†Ø²ÙŠÙ„ Excel</label>
    </div>
    <button class="btn" id="saveBtn">Ø­ÙØ¸</button>
    <button class="btn btn-danger" onclick="resetForm();">Ø¥Ù„ØºØ§Ø¡</button>
  </form>

  <table>
    <thead>
      <tr><th>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th><th>Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª</th><th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr>
    </thead>
    <tbody id="usersList"></tbody>
  </table>

  <script>
    const SECRET_KEY = "smart_era_secret_@2024";
    const USERS_KEY = "smart_era_users";
    const SESSION_KEY = "auth";
    let isEditMode = false;
    let currentEditIndex = null;

    // Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØ´ÙÙŠØ± ÙˆØ§Ù„ØªØ­Ù‚Ù‚
    function decryptSession() {
      try {
        const encrypted = sessionStorage.getItem(SESSION_KEY);
        if (!encrypted) throw new Error();
        const session = JSON.parse(CryptoJS.AES.decrypt(encrypted, SECRET_KEY).toString(CryptoJS.enc.Utf8));
        if (Date.now() - session.timestamp > 3600000) throw new Error();
        return session;
      } catch { handleAuthError(); }
    }
    function handleAuthError() { alert('Ø§Ù†ØªÙ‡Øª ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ø¬Ù„Ø³Ø©'); location.href='login.html'; }
    function verifyAdminPermissions() { const s = decryptSession(); if (!s?.permissions?.includes('admin')) handleAuthError(); }

    // Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
    function getUsers() {
      const enc = localStorage.getItem(USERS_KEY);
      if (!enc) return [];
      return JSON.parse(CryptoJS.AES.decrypt(enc, SECRET_KEY).toString(CryptoJS.enc.Utf8));
    }
    function saveUsers(users) {
      localStorage.setItem(USERS_KEY, CryptoJS.AES.encrypt(JSON.stringify(users), SECRET_KEY).toString());
      renderUsers();
    }

    function showStatus(msg, type) {
      const div = document.createElement('div');
      div.className = `status-message ${type}`;
      div.textContent = msg;
      document.getElementById('userForm').append(div);
      div.style.display = 'block';
      setTimeout(()=>div.remove(), 3000);
    }

    function validateUser(u) {
      const errs=[];
      if (!/^[\w]{3,20}$/.test(u.username)) errs.push('Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… 3-20 Ø­Ø±Ù');
      if (!/^(?=.*[a-z])(?=.*[A-Z])(?=.*\d).{8,}$/.test(u.password)) errs.push('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù…Ø¹Ù‚Ø¯Ø©');
      return errs;
    }

    function addUser() {
      const user={
        username: document.getElementById('username').value.trim(),
        password: document.getElementById('password').value,
        permissions: Array.from(document.querySelectorAll('#userForm input[type=checkbox]:checked')).map(c=>c.value),
      };
      const errs=validateUser(user);
      if (errs.length) return showStatus(errs.join(', '), 'error');
      const users=getUsers();
      if (users.find(u=>u.username===user.username)) return showStatus('Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯', 'error');
      users.push(user);
      saveUsers(users);
      resetForm();
      showStatus('ØªÙ… Ø§Ù„Ø¥Ø¶Ø§ÙØ©', 'success');
    }

    function renderUsers() {
      const tbody=document.getElementById('usersList');
      tbody.innerHTML='';
      getUsers().forEach((u,i)=>{
        const tr=document.createElement('tr');
        tr.innerHTML = `
          <td>${u.username}</td>
          <td>${u.permissions.join('ØŒ ') || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}</td>
          <td>
            <button class="btn" onclick="editUser(${i})">âœï¸</button>
            <button class="btn btn-danger" onclick="deleteUser(${i})">ğŸ—‘ï¸</button>
          </td>`;
        tbody.append(tr);
      });
    }

    function editUser(i) {
      const u = getUsers()[i];
      document.getElementById('username').value = u.username;
      document.getElementById('password').value = u.password;
      document.querySelectorAll('#userForm input[type=checkbox]').forEach(cb => cb.checked = u.permissions.includes(cb.value));
      isEditMode = true; currentEditIndex = i;
      document.getElementById('saveBtn').textContent = 'ØªØ­Ø¯ÙŠØ«';
    }

    function updateUser() {
      const users=getUsers();
      const u = users[currentEditIndex];
      u.password = document.getElementById('password').value;
      u.permissions = Array.from(document.querySelectorAll('#userForm input[type=checkbox]:checked')).map(c=>c.value);
      saveUsers(users);
      resetForm(); showStatus('ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«', 'success');
    }

    function deleteUser(i) {
      const users=getUsers(); users.splice(i,1); saveUsers(users); showStatus('ØªÙ… Ø§Ù„Ø­Ø°Ù', 'success');
    }

    function resetForm() {
      document.getElementById('userForm').reset();
      isEditMode=false; currentEditIndex=null;
      document.getElementById('saveBtn').textContent = 'Ø­ÙØ¸';
    }

    function togglePassword() {
      const pw = document.getElementById('password');
      pw.type = pw.type === 'password' ? 'text' : 'password';
    }

    document.addEventListener('DOMContentLoaded', () => {
      verifyAdminPermissions();
      renderUsers();
    });
  </script>
</body>
</html>
