<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <!-- ... (بقية الهيد بدون تغيير) ... -->
  
  <style>
    /* إضافة أنماط جديدة */
    .password-field {
      position: relative;
    }
    
    .toggle-password {
      position: absolute;
      left: 10px;
      top: 50%;
      transform: translateY(-50%);
      cursor: pointer;
    }
    
    .status-message {
      padding: 0.5rem;
      border-radius: 6px;
      margin-top: 1rem;
      display: none;
    }
    
    .success { background: #dcfce7; color: #166534; }
    .error { background: #fee2e2; color: #dc2626; }
  </style>
</head>
<body>
  <!-- ... (بقية الهيكل كما هو) ... -->

  <script>
    // التعديلات على الجزء البرمجي

    const SECRET_KEY = "smart_era_secret_@2024";
    const USERS_KEY = "smart_era_users";
    const SESSION_KEY = "auth";

    let isEditMode = false;
    let currentEditIndex = null;

    // تحسين دالة فك التشفير
    function decryptSession() {
      try {
        const encrypted = sessionStorage.getItem(SESSION_KEY);
        if (!encrypted) throw new Error('No session found');
        
        const bytes = CryptoJS.AES.decrypt(encrypted, SECRET_KEY);
        const session = JSON.parse(bytes.toString(CryptoJS.enc.Utf8));
        
        // التحقق من صلاحية الجلسة (1 ساعة)
        const sessionAge = Date.now() - session.timestamp;
        if (sessionAge > 3600000) throw new Error('انتهت صلاحية الجلسة');
        
        return session;
      } catch (error) {
        console.error('فك التشفير فشل:', error);
        handleAuthError();
        return null;
      }
    }

    // تحسين التحقق من الصلاحيات
    function verifyAdminPermissions() {
      const session = decryptSession();
      const isHrAdmin = session?.user === 'hr' && session?.permissions?.includes('admin');
      
      if (!isHrAdmin) {
        alert('⚠️ يلزم صلاحيات المدير للوصول لهذه الصفحة');
        window.location.href = 'index.html';
      }
    }

    // تحسين دالة حفظ المستخدمين
    function saveUsers(users) {
      try {
        const encrypted = CryptoJS.AES.encrypt(
          JSON.stringify(users), 
          SECRET_KEY
        ).toString();
        localStorage.setItem(USERS_KEY, encrypted);
        showStatus('تم الحفظ بنجاح', 'success');
      } catch (error) {
        showStatus('فشل في الحفظ: ' + error.message, 'error');
      }
    }

    // إضافة دالة لعرض الحالة
    function showStatus(message, type) {
      const statusEl = document.createElement('div');
      statusEl.className = `status-message ${type}`;
      statusEl.textContent = message;
      
      const form = document.getElementById('userForm');
      form.appendChild(statusEl);
      
      setTimeout(() => statusEl.remove(), 3000);
    }

    // تحسين دالة إضافة مستخدم
    function addUser() {
      try {
        const newUser = getFormData();
        
        // تحسين التحقق من البيانات
        const validationErrors = validateUser(newUser);
        if (validationErrors.length > 0) {
          throw new Error(validationErrors.join('\n'));
        }

        const users = getUsers();
        
        // منع تكرار أسماء المستخدمين
        if (users.some(u => u.username.toLowerCase() === newUser.username.toLowerCase())) {
          throw new Error('اسم المستخدم موجود مسبقاً');
        }

        users.push(newUser);
        saveUsers(users);
        renderUsers();
        resetForm();
      } catch (error) {
        showStatus(error.message, 'error');
      }
    }

    // تحسين دالة التحقق من البيانات
    function validateUser({ username, password }) {
      const errors = [];
      const usernameRegex = /^[a-zA-Z0-9_]{3,20}$/;
      const passwordRegex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d).{8,}$/;

      if (!usernameRegex.test(username)) {
        errors.push('اسم المستخدم يجب أن يحتوي 3-20 حرفاً (أرقام/حروف/_)');
      }
      
      if (!passwordRegex.test(password)) {
        errors.push('كلمة المرور يجب أن تحتوي 8 أحرف على الأقل، حرف كبير وصغير ورقم');
      }

      return errors;
    }

    // تحسين دالة العرض
    function renderUsers() {
      const tbody = document.getElementById('usersList');
      const users = getUsers();
      
      tbody.innerHTML = users.map((user, index) => {
        const isCurrentUser = user.username === decryptSession()?.user;
        
        return `
          <tr>
            <td>${user.username}</td>
            <td>
              ${user.permissions.includes('admin') 
                ? '<span class="badge admin">مدير كامل</span>' 
                : user.permissions.join('، ') || 'لا يوجد'}
            </td>
            <td>
              ${user.username === 'hr' 
                ? '<span class="text-muted">غير مسموح</span>'
                : `
                  <button class="btn btn-edit" 
                    onclick="editUser(${index})"
                    ${isCurrentUser ? 'disabled' : ''}>
                    ✏️ تعديل
                  </button>
                  <button class="btn btn-danger" 
                    onclick="deleteUser(${index})"
                    ${isCurrentUser ? 'disabled' : ''}>
                    🗑️ حذف
                  </button>
                `}
            </td>
          </tr>
        `;
      }).join('');
    }

    // الباقي بدون تغيير
    // ...
    
  </script>
</body>
</html>
