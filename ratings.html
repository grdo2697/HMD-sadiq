<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>تقييمات موظفين شركة العصر الذكي</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary: #3b82f6;
      --primary-dark: #2563eb;
      --secondary: #60a5fa;
      --accent: #f59e0b;
      --accent-dark: #d97706;
      --background: #f8fafc;
      --card-bg: #ffffff;
      --text: #1e293b;
      --text-light: #64748b;
      --border: #e2e8f0;
      --hover: #f1f5f9;
      --success: #10b981;
      --error: #ef4444;
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --radius: 12px;
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .dark-mode {
      --primary: #60a5fa;
      --primary-dark: #3b82f6;
      --secondary: #93c5fd;
      --accent: #fbbf24;
      --accent-dark: #f59e0b;
      --background: #0f172a;
      --card-bg: #1e293b;
      --text: #f8fafc;
      --text-light: #94a3b8;
      --border: #334155;
      --hover: #1e293b;
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.25), 0 2px 4px -1px rgba(0, 0, 0, 0.15);
    }

    * {
      font-family: 'Cairo', sans-serif;
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      background: var(--background);
      color: var(--text);
      transition: var(--transition);
      min-height: 100vh;
    }

    header {
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      padding: 2rem 1rem;
      border-radius: 0 0 30px 30px;
      text-align: center;
      box-shadow: var(--shadow);
      position: relative;
      overflow: hidden;
    }

    header::after {
      content: "";
      position: absolute;
      top: 0;
      right: 0;
      bottom: 0;
      left: 0;
      background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0));
      pointer-events: none;
    }

    h1 {
      color: white;
      font-size: 2.2rem;
      margin: 0;
      font-weight: 700;
      position: relative;
      z-index: 1;
    }

    .container {
      max-width: 1400px;
      margin: 2rem auto;
      padding: 0 1rem;
    }

    .controls {
      display: flex;
      flex-wrap: wrap;
      justify-content: flex-end;
      gap: 0.75rem;
      margin-bottom: 1.5rem;
      align-items: center;
    }

    .btn {
      padding: 0.75rem 1.25rem;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: var(--radius);
      cursor: pointer;
      font-size: 0.95rem;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      transition: var(--transition);
      box-shadow: var(--shadow);
    }

    .btn:hover {
      background: var(--primary-dark);
      transform: translateY(-2px);
    }

    .btn-outline {
      background: transparent;
      border: 2px solid var(--primary);
      color: var(--primary);
    }

    .btn-outline:hover {
      background: var(--primary);
      color: white;
    }

    .btn-accent {
      background: var(--accent);
    }

    .btn-accent:hover {
      background: var(--accent-dark);
    }

    .btn-danger {
      background: var(--error);
    }

    .btn-danger:hover {
      background: #dc2626;
    }

    .btn-success {
      background: var(--success);
    }

    .btn-success:hover {
      background: #059669;
    }

    select, input {
      padding: 0.75rem 1rem;
      border: 2px solid var(--border);
      border-radius: var(--radius);
      font-size: 0.95rem;
      background: var(--card-bg);
      color: var(--text);
      transition: var(--transition);
      box-shadow: var(--shadow);
    }

    select:focus, input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
    }

    input[type="text"] {
      min-width: 250px;
    }

    .search-container {
      position: relative;
      flex-grow: 1;
    }

    .search-container i {
      position: absolute;
      left: 1rem;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-light);
    }

    .search-container input {
      width: 100%;
      padding-right: 1rem;
      padding-left: 2.5rem;
    }

    .table-container {
      background: var(--card-bg);
      border-radius: var(--radius);
      overflow: hidden;
      box-shadow: var(--shadow);
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 800px;
    }

    th, td {
      padding: 1.25rem 1rem;
      border-bottom: 1px solid var(--border);
      text-align: right;
    }

    th {
      background: rgba(59, 130, 246, 0.1);
      color: var(--primary);
      font-weight: 700;
      position: sticky;
      top: 0;
      cursor: pointer;
      transition: var(--transition);
      white-space: nowrap;
    }

    th:hover {
      background: rgba(59, 130, 246, 0.2);
    }

    th i {
      margin-left: 0.5rem;
      opacity: 0.7;
    }

    td {
      color: var(--text-light);
    }

    tr:last-child td {
      border-bottom: none;
    }

    tr:hover td {
      background-color: var(--hover);
      color: var(--text);
    }

    .rating-cell {
      font-weight: 600;
      color: var(--text);
    }

    .high-rating {
      color: var(--success);
    }

    .medium-rating {
      color: var(--accent);
    }

    .low-rating {
      color: var(--error);
    }

    footer {
      text-align: center;
      padding: 1.5rem;
      color: var(--text-light);
      font-size: 0.9rem;
      border-top: 1px solid var(--border);
      margin-top: 3rem;
    }

    .loading {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 2rem;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid rgba(59, 130, 246, 0.2);
      border-top: 4px solid var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .empty-state {
      text-align: center;
      padding: 3rem;
      color: var(--text-light);
    }

    .empty-state i {
      font-size: 3rem;
      margin-bottom: 1rem;
      color: var(--border);
    }

    .empty-state p {
      font-size: 1.1rem;
      margin-top: 0.5rem;
    }

    .toast {
      position: fixed;
      bottom: 1rem;
      left: 50%;
      transform: translateX(-50%);
      background: var(--card-bg);
      color: var(--text);
      padding: 1rem 1.5rem;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      display: flex;
      align-items: center;
      gap: 0.75rem;
      z-index: 1000;
      opacity: 0;
      transition: var(--transition);
    }

    .toast.show {
      opacity: 1;
      bottom: 2rem;
    }

    .toast.success {
      border-left: 4px solid var(--success);
    }

    .toast.error {
      border-left: 4px solid var(--error);
    }

    .toast i {
      font-size: 1.25rem;
    }

    @media (max-width: 768px) {
      .controls {
        flex-direction: column;
        align-items: stretch;
      }
      
      .btn {
        width: 100%;
        justify-content: center;
      }
      
      input[type="text"] {
        min-width: auto;
      }
      
      h1 {
        font-size: 1.8rem;
      }
    }
  </style>
</head>
<body>
  <script>
    // الحماية - منع الوصول بدون تسجيل دخول
    const username = localStorage.getItem("username");
    if (!username) {
      window.location.href = "login.html";
    }
  </script>

  <header>
    <h1><i class="fas fa-star"></i> عرض التقييمات</h1>
  </header>

  <div class="container">
    <div class="controls">
      <button class="btn btn-success" onclick="fetchReviews()">
        <i class="fas fa-sync-alt"></i> تحديث البيانات
      </button>
      <button class="btn btn-danger" onclick="clearTable()">
        <i class="fas fa-trash"></i> مسح الكل
      </button>
      <button class="btn btn-accent" onclick="downloadExcel()">
        <i class="fas fa-file-excel"></i> تصدير Excel
      </button>
      <select id="gradeFilter" onchange="filterTable()">
        <option value="">جميع الدرجات الوظيفية</option>
      </select>
      <button class="btn btn-outline" onclick="sortBy('operationRating')">
        <i class="fas fa-sort-amount-down"></i> عدد العمليات
      </button>
      <button class="btn btn-outline" onclick="sortBy('overallRating')">
        <i class="fas fa-star"></i> التقييم الكلي
      </button>
      <button class="btn" onclick="toggleDarkMode()">
        <i class="fas fa-moon"></i> وضع ليلي
      </button>
      <div class="search-container">
        <i class="fas fa-search"></i>
        <input type="text" id="searchInput" placeholder="ابحث عن موظف أو قسم..." oninput="filterTable()">
      </div>
      <button class="btn" onclick="window.location.href='index.html'">
        <i class="fas fa-arrow-right"></i> رجوع
      </button>
    </div>

    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th onclick="sortBy('name')">اسم الموظف <i class="fas fa-sort"></i></th>
            <th onclick="sortBy('department')">القسم <i class="fas fa-sort"></i></th>
            <th onclick="sortBy('jobGrade')">الدرجة الوظيفية <i class="fas fa-sort"></i></th>
            <th onclick="sortBy('overallRating')">التقييم الكلي <i class="fas fa-sort"></i></th>
            <th onclick="sortBy('operationRating')">تقييم العمليات <i class="fas fa-sort"></i></th>
            <th onclick="sortBy('ratingDays')">أيام التقييم <i class="fas fa-sort"></i></th>
            <th onclick="sortBy('reviewDate')">تاريخ التقييم <i class="fas fa-sort"></i></th>
          </tr>
        </thead>
        <tbody id="reviews-body">
          <tr>
            <td colspan="7" class="empty-state">
              <i class="fas fa-database"></i>
              <p>لا توجد بيانات لعرضها</p>
              <button class="btn" onclick="fetchReviews()">
                <i class="fas fa-sync-alt"></i> جلب البيانات
              </button>
            </td>
          </tr>
        </tbody>
      </table>
      <div id="loading" class="loading" style="display: none;">
        <div class="spinner"></div>
      </div>
    </div>
  </div>

  <footer>
    جميع الحقوق محفوظة &copy; <span id="year"></span> | نظام إدارة الموظفين - شركة العصر الذكي
  </footer>

  <div id="toast" class="toast">
    <i class="fas fa-check-circle"></i>
    <span id="toast-message"></span>
  </div>

  <script>
    let reviewsData = [];
    let currentSort = {
      column: null,
      direction: 'asc'
    };

    document.getElementById("year").textContent = new Date().getFullYear();

    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      const toastMessage = document.getElementById('toast-message');
      
      toast.className = `toast ${type}`;
      toastMessage.textContent = message;
      
      const icon = toast.querySelector('i');
      icon.className = type === 'success' ? 'fas fa-check-circle' : 'fas fa-exclamation-circle';
      
      toast.classList.add('show');
      
      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }

    async function fetchReviews() {
      try {
        document.getElementById('loading').style.display = 'flex';
        document.getElementById('reviews-body').innerHTML = '';
        
        // استخدم رابط النشر الخاص بك من Google Apps Script
        const scriptUrl = "https://script.google.com/macros/s/AKfycbz8XfV3zzAw4DhpyfOSQ5A9LxLQ9Jprzsb4ofD8uYi81dss6bJ9GnpzpsaL65P-m5K0_g/exec
        
        const response = await fetch(`${scriptUrl}?sheet=تقييمات`);
        
        if (!response.ok) {
          throw new Error(`خطأ في الشبكة: ${response.status}`);
        }
        
        const result = await response.json();
        
        if (!result.success) {
          throw new Error(result.error || 'فشل جلب البيانات');
        }
        
        // تحويل البيانات لتتطابق مع الهيكل المطلوب
        reviewsData = result.data.map(review => ({
          name: review.الاسم || 'غير محدد',
          department: review.القسم || 'غير محدد',
          jobGrade: review.الدرجة_الوظيفية || review.الدرجة || 'غير محدد',
          overallRating: parseFloat(review.التقييم) || 0,
          operationRating: parseFloat(review.تقييم_العمليات || review.تقييم_الأداء || 0) || 0,
          ratingDays: parseInt(review.أيام_التقييم || review.مدة_التقييم || 0) || 0,
          reviewDate: review.التاريخ || review.تاريخ_التقييم || 'غير محدد'
        }));
        
        populateGradeFilter();
        displayReviews(reviewsData);
        showToast('تم تحديث البيانات بنجاح', 'success');
      } catch (error) {
        console.error("Error fetching reviews:", error);
        showToast(`حدث خطأ أثناء جلب البيانات: ${error.message}`, 'error');
        document.getElementById('reviews-body').innerHTML = `
          <tr>
            <td colspan="7" class="empty-state">
              <i class="fas fa-exclamation-triangle"></i>
              <p>حدث خطأ في جلب البيانات</p>
              <button class="btn" onclick="fetchReviews()">
                <i class="fas fa-sync-alt"></i> المحاولة مرة أخرى
              </button>
            </td>
          </tr>
        `;
      } finally {
        document.getElementById('loading').style.display = 'none';
      }
    }

    function displayReviews(reviews) {
      const tbody = document.getElementById("reviews-body");
      
      if (!reviews || reviews.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="7" class="empty-state">
              <i class="fas fa-search"></i>
              <p>لا توجد نتائج مطابقة للبحث</p>
              <button class="btn" onclick="clearFilters()">
                <i class="fas fa-times"></i> مسح الفلتر
              </button>
            </td>
          </tr>
        `;
        return;
      }
      
      tbody.innerHTML = "";
      reviews.forEach(review => {
        const overallRatingClass = getRatingClass(review.overallRating);
        const operationRatingClass = getRatingClass(review.operationRating);
        
        const row = `
          <tr>
            <td>${review.name}</td>
            <td>${review.department}</td>
            <td>${review.jobGrade}</td>
            <td class="rating-cell ${overallRatingClass}">${review.overallRating.toFixed(1)}</td>
            <td class="rating-cell ${operationRatingClass}">${review.operationRating.toFixed(1)}</td>
            <td>${review.ratingDays}</td>
            <td>${review.reviewDate}</td>
          </tr>
        `;
        tbody.innerHTML += row;
      });
    }

    function getRatingClass(rating) {
      if (rating >= 4) return 'high-rating';
      if (rating >= 2.5) return 'medium-rating';
      return 'low-rating';
    }

    function populateGradeFilter() {
      const select = document.getElementById("gradeFilter");
      const uniqueGrades = [...new Set(reviewsData.map(r => r.jobGrade).filter(Boolean))].sort();
      
      select.innerHTML = `<option value="">جميع الدرجات الوظيفية</option>`;
      uniqueGrades.forEach(grade => {
        select.innerHTML += `<option value="${grade}">${grade}</option>`;
      });
    }

    function clearTable() {
      if (reviewsData.length === 0) {
        showToast('لا توجد بيانات لمسحها', 'error');
        return;
      }
      
      if (confirm('هل أنت متأكد من رغبتك في مسح جميع البيانات المعروضة؟')) {
        reviewsData = [];
        document.getElementById("reviews-body").innerHTML = `
          <tr>
            <td colspan="7" class="empty-state">
              <i class="fas fa-database"></i>
              <p>لا توجد بيانات لعرضها</p>
              <button class="btn" onclick="fetchReviews()">
                <i class="fas fa-sync-alt"></i> جلب البيانات
              </button>
            </td>
          </tr>
        `;
        showToast('تم مسح البيانات بنجاح', 'success');
      }
    }

    function downloadExcel() {
      if (reviewsData.length === 0) {
        showToast('لا توجد بيانات لتصديرها', 'error');
        return;
      }
      
      try {
        let csvContent = "data:text/csv;charset=utf-8,";
        
        // Headers
        const headers = [
          'اسم الموظف', 'القسم', 'الدرجة الوظيفية', 
          'التقييم الكلي', 'تقييم العمليات', 'أيام التقييم', 'تاريخ التقييم'
        ];
        csvContent += headers.join(",") + "\r\n";
        
        // Data rows
        reviewsData.forEach(review => {
          const row = [
            `"${review.name || ''}"`,
            `"${review.department || ''}"`,
            `"${review.jobGrade || ''}"`,
            review.overallRating.toFixed(1),
            review.operationRating.toFixed(1),
            review.ratingDays,
            `"${review.reviewDate || ''}"`
          ];
          csvContent += row.join(",") + "\r\n";
        });
        
        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", `تقييمات_الموظفين_${new Date().toLocaleDateString('ar-EG')}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        showToast('تم تصدير البيانات بنجاح', 'success');
      } catch (error) {
        console.error("Error exporting data:", error);
        showToast('حدث خطأ أثناء تصدير البيانات', 'error');
      }
    }

    function filterTable() {
      const input = document.getElementById("searchInput").value.toLowerCase();
      const grade = document.getElementById("gradeFilter").value;
      
      const filtered = reviewsData.filter(r => {
        const searchFields = `${r.name || ''} ${r.department || ''} ${r.jobGrade || ''}`.toLowerCase();
        const matchSearch = searchFields.includes(input);
        const matchGrade = !grade || r.jobGrade === grade;
        return matchSearch && matchGrade;
      });
      
      displayReviews(filtered);
    }

    function clearFilters() {
      document.getElementById("searchInput").value = '';
      document.getElementById("gradeFilter").value = '';
      filterTable();
    }

    function sortBy(column) {
      // Update sort direction if clicking on the same column
      if (currentSort.column === column) {
        currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
      } else {
        currentSort.column = column;
        currentSort.direction = 'asc';
      }
      
      // Update sort indicators
      document.querySelectorAll('th i').forEach(icon => {
        icon.className = 'fas fa-sort';
      });
      
      const header = document.querySelector(`th[onclick="sortBy('${column}')"]`);
      if (header) {
        const icon = header.querySelector('i');
        icon.className = currentSort.direction === 'asc' 
          ? 'fas fa-sort-up' 
          : 'fas fa-sort-down';
      }
      
      // Sort the data
      reviewsData.sort((a, b) => {
        const valA = a[column];
        const valB = b[column];
        
        if (typeof valA === 'string' && typeof valB === 'string') {
          return currentSort.direction === 'asc' 
            ? valA.localeCompare(valB, 'ar') 
            : valB.localeCompare(valA, 'ar');
        } else {
          return currentSort.direction === 'asc' 
            ? (valA || 0) - (valB || 0) 
            : (valB || 0) - (valA || 0);
        }
      });
      
      displayReviews(reviewsData);
    }

    function toggleDarkMode() {
      document.body.classList.toggle("dark-mode");
      const isDark = document.body.classList.contains("dark-mode");
      localStorage.setItem('darkMode', isDark);
      
      const icon = document.querySelector('button[onclick="toggleDarkMode()"] i');
      icon.className = isDark ? 'fas fa-sun' : 'fas fa-moon';
      
      showToast(`تم تفعيل الوضع ${isDark ? 'الليلي' : 'النهاري'}`, 'success');
    }

    // Initialize dark mode from localStorage
    if (localStorage.getItem('darkMode') === 'true') {
      document.body.classList.add("dark-mode");
      const icon = document.querySelector('button[onclick="toggleDarkMode()"] i');
      if (icon) icon.className = 'fas fa-sun';
    }

    // Initial fetch
    fetchReviews();
  </script>
</body>
</html>
