<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>تقييمات الموظفين</title>
  <link rel="stylesheet" href="styles.css"> <!-- إذا كان لديك ملف CSS مخصص -->
</head>
<body>
  <header>
    <h1>تقييمات الموظفين</h1>
  </header>

  <main>
    <input type="text" id="searchInput" placeholder="ابحث عن موظف أو قسم" />
    <button onclick="exportToExcel()">تصدير إلى Excel</button>

    <table id="reviews-table">
      <thead>
        <tr>
          <th>اسم الموظف</th>
          <th>القسم</th>
          <th>الدرجة الوظيفية</th>
          <th>التقييم الكلي</th>
          <th>التقييم حسب عدد العمليات</th>
          <th>عدد أيام التقييم</th>
        </tr>
      </thead>
      <tbody id="reviews-body">
        <!-- سيتم ملء البيانات هنا بواسطة JavaScript -->
      </tbody>
    </table>
  </main>

  <footer>
    <p>جميع الحقوق محفوظة © <span id="year"></span></p>
  </footer>

  <script>
    // التحقق من صلاحية المستخدم قبل تحميل الصفحة
    const userRole = localStorage.getItem("userRole");
    if (userRole !== "hr") {
      alert("ليس لديك صلاحية الوصول إلى هذه الصفحة.");
      window.location.href = "index.html";
    } else {
      document.getElementById("reviews-container").style.display = "block";
      fetchReviews();
    }

    // دالة جلب التقييمات
    async function fetchReviews() {
      try {
        const response = await fetch("https://script.google.com/macros/s/AKfycbx4vXm_J_nmdrbTkQzbLMfVT65E9VNpgZlw5e94UMcAZ4D69ZWgyFLSJgdXiNCjs2mKiQ/exec");
        const reviews = await response.json();
        displayReviews(reviews);
      } catch (error) {
        console.error("Error fetching reviews:", error);
        alert("حدث خطأ أثناء جلب التقييمات.");
      }
    }

    // دالة لعرض التقييمات في الجدول
    function displayReviews(reviews) {
      const tbody = document.getElementById("reviews-body");
      reviews.forEach(review => {
        const row = `
          <tr>
            <td>${review.name}</td>
            <td>${review.department}</td>
            <td>${review.jobGrade}</td>
            <td>${review.overallRating}</td>
            <td>${review.operationRating}</td>
            <td>${review.ratingDays}</td>
          </tr>
        `;
        tbody.innerHTML += row;
      });
    }

    // دالة لتصفية التقييمات حسب البحث
    function searchReviews() {
      const searchInput = document.getElementById('searchInput').value.toLowerCase();
      const rows = document.querySelectorAll('tbody tr');
      rows.forEach(row => {
        const name = row.cells[0].textContent.toLowerCase();
        const department = row.cells[1].textContent.toLowerCase();
        if (name.includes(searchInput) || department.includes(searchInput)) {
          row.style.display = '';
        } else {
          row.style.display = 'none';
        }
      });
    }

    // دالة لتصدير البيانات إلى Excel
    function exportToExcel() {
      const table = document.querySelector('table');
      const rows = Array.from(table.rows);
      const csvData = rows.map(row => {
        return Array.from(row.cells).map(cell => cell.textContent).join(',');
      }).join('\n');

      const blob = new Blob([csvData], { type: 'text/csv' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = 'reviews.csv';
      link.click();
    }

    // إضافة مستمع حدث للبحث
    document.getElementById("searchInput").addEventListener("input", searchReviews);

    // إضافة السنة الحالية في الفوتر
    document.getElementById("year").textContent = new Date().getFullYear();
  </script>
</body>
</html>
